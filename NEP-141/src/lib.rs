use near_contract_standards::fungible_token::metadata::{
    FungibleTokenMetadata, FungibleTokenMetadataProvider, FT_METADATA_SPEC,
};
use near_contract_standards::fungible_token::FungibleToken;
use near_sdk::borsh::{self, BorshDeserialize, BorshSerialize};
use near_sdk::collections::LazyOption;
use near_sdk::json_types::U128;
use near_sdk::{env, log, near_bindgen, AccountId, Balance, PanicOnDefault, PromiseOrValue};

#[near_bindgen]
#[derive(BorshDeserialize, BorshSerialize, PanicOnDefault)]
pub struct Contract {
    token: FungibleToken,
    metadata: LazyOption<FungibleTokenMetadata>,
}

const DATA_IMAGE_SVG_NEAR_ICON: &str = "data:image/vnd.microsoft.icon;base64,AAABAAEAMDAAAAEAIACoJQAAFgAAACgAAAAwAAAAYAAAAAEAIAAAAAAAgCUAAAAAAAAAAAAAAAAAAAAAAAD+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v/+/v7//v7+//7+/v////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////7//v///////////////////////////////////////////////////////////////////////////////////////////////v//////0+69/8vqsf/n9dv/4/TV/+X02P/c8cr/4fPR/+P01v/l9dn/5vXb/9zxzP/h89P/4fPT/+z34//A5p//2O/F/9/y0P/j9Nb/4/TU/9rwyf/W78H/xOek/9zxy//d8s7/5PTX/+T01//e8s7/4/TV/9zxy//X78P/6Pbe/+T01//Y78X/1e7C/+P01f/I6av/5/Xb/+f13P/Z8Mb/3fHN/97yzv/k9Nj/zeuy/8rqsP/e8s//6fbf////////////5vXX/+j42//x+ev/9fzu//D76f/u+eT/7Prg/+v64P/z/Oz/7/rn/+z35P/q9+D/8fvp//X97//f88z/8frq//L86//r9+H/5vXa//H66//y/en/4vbO/+745v/s+eH/5vba//D56P/0/uz/8vzq//D75v/c8sn/8fvq/+/45//2/fD/6vjg/+v34P/h9c//8frq//D56v/2/vD/7/vl/+/75//u+eX/5PfT/+f42f/s+OP/9fvw///////9/v3////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+//////////////////////////////////////////////////////////////////////////////7+/v//////39/f/2tqa///////d3d3/5ycnP+/v7//R0dH/1dXV/+BgYH/cnJy///////Ozc7/dnZ2/4eHh//Y2Nj/wL/A/35+fv///////////6ysrP9CQkL/S0tL/9ra2v+AgID/2tra/8vLy/88PDz/YmJi/35+fv/BwcH/h4eH//////+MjIz/srKy//////9mZmb/6enp//j4+P9DQ0P/VFRU/35+fv+3t7f/RUVF/0dHR/+ZmZn/////////////////0dHR/0BAQP/c3Nz/AAAA/4SEhP+Tk5P/W1tb//Pz8//29vb/IyMj/1NTU/8gICD/nJyc/2NjY/+cnJz/TExM/66urv/r6+v/4eHh/8HBwf/c3Nz/W1tb/11dXf9YWFj/ubm5/zU1Nf+6urr/iYmJ/yUlJf+oqKj/UVFR//////9YWFj/lJSU//////8mJib/4ODg/+jo6P8cHBz/3d3d//////9/f3//YmJi//Pz8/8aGhr/ycnJ////////////29vb/z09Pf9BQUH/VlZW/4+Pj/+ioqL/Ly8v/29vb///////goKC/3Jycv84ODj/+fn5/2pqav9FRUX/Ozs7/9ra2v9mZmb/a2tr/8/Pz/9NTU3/Xl5e/+np6f9aWlr/qqqq/zMzM//19fX/fX19/52dnf+7u7v/FxcX/1BQUP8ZGRn/ra2t//////84ODj/8fHx//f39/8TExP/Z2dn/8jIyP+QkJD/gICA//////9NTU3/mpqa////////////4+Pj/wAAAP95eXn/q6ur/3R0dP+RkZH/Q0ND/729vf/s7Oz/5ubm/wAAAP9LS0v//////0tLS/+Kior/Wlpa/3d3d////////////1dXV/9PT0//uLi4//b29v9BQUH/v7+//1NTU/98fHz/sbGx/7i4uP+oqKj/RkZG//////9UVFT/jY2N/83Nzf8SEhL/mpqa/8/Pz/8XFxf/r6+v/9ra2v+EhIT/SEhI/7CwsP8YGBj/4eHh////////////7u7u/3x8fP//////0dHR/7y8vP/U1NT/dXV1/3BwcP/CwsL//////319ff/Dw8P//////6+vr/9ycnL/g4OD//Pz8////////////+3t7f92dnb/a2tr/+zs7P+oqKj/4+Pj//7+/v9vb2//ZmZm/9ra2v/Z2dn/rKys//////+5ubn/v7+//3p6ev93d3f/bW1t/8nJyf+Ghob/cHBw/5eXl//T09P/cnJy/25ubv/Q0ND////////////+/v7//////////////////////////////////////////////////v7+////////////+/v7///////////////////////9/f3//f39//////////////////////////////////////////////////////////////////v7+////////////////////////////////////////////////////////////////////////v7+//7+/v/////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////+/v7/////////////////5ubm/8DAwP+4uLj/zs7O//n5+f////////////7+/v/////////////////////////////////+/v7/////////////////1NTU/7q6uv+9vb3/3t7e//////////////////7+/v////////////////////////////////////////////////////////////////////////////////////////////7+/v///////////8zMzP9UVFT/JiYm/ywsLP8wMDD/JiYn/zAwMf+CgoL/+/v7//////////////////////////////////7+/v///////////5eXmP85OTn/JyYn/zAvMP8tLS7/JSQl/0VFRv+1tbX////////////+/v7//////////////////////////////////////////////////////////////////////////////////v7+////////////j4+Q/xIRFP9JSEv/j46R/6Cfov+sq63/mJea/39+gf8mJSj/MC8y/9/f3////////v7+/////////////v7+///////29vb/R0ZI/xsZHP9mZWf/mZmb/6Skpv+npaj/kI+R/2NjZf8WFhj/bW1v/////////////v7+//////////////////////////////////////////////////////////////////////////////////////+Xlpj/ERMP/4OSd/+0xqf/s8Ol/6q6m/+tvqD/rL2e/7jHqf+uvp//SlVD/yYlJv/w7/D///////////////////////////8/P0D/NDwv/6i2mP+0w6X/r7+h/6q6m/+uvZ//r7+h/7rLq/+Yp4n/Gx8Y/3Fwcv///////////////////////////////////////////////////////////////////////////////////////////9/f3/8bGRz/jpSG/83dvP+9zq3/uMio/7zKq/+5yqv/uMip/7rJqv/C0rH/yNW4/0BEQP9eXl///////////////////////4eGh/8qKin/vcmw/8TVtv+8y6z/ucep/7rJrP+6yqv/ucip/7rJrP/J2Lr/pK+a/xgZGf++vb7//////////////////////////////////////////////////////////////////////////////////////3Jycv9HR0f/3Nzb/7i3uf+pqav/x8fI/7y7vP+vr7H/yMfJ/7++wP/Av8H/2NjZ/6Giof8dHR3/3d3d////////////9/f3/yoqKv+RkZD/3Nzd/7Oztf+ura//ycjK/7i4uf+ysbP/yMfJ/728vv/CwsP/3Nzc/15fXv9OTk7//////////////////////////////////////////////////////////////////////////////////////zk5Of9lZWX/zMvM/4mIif9xcHH/wsLC/5STlP+GhYb/xsbG/5eXmP+Hhof/ycnJ/5qamv8hISH/lZWV////////////u7u7/xwcHP+IiIn/ycnJ/4aGhv9+fn//xMPE/4uKi/+Ojo7/x8fI/4yMjf+NjY7/zc3N/3t7e/8mJib/6urq////////////////////////////////////////////////////////////////////////////7Ozs/y0tLf92dnb/wcHB/5+fn/+Ojo7/x8fH/6qqqv+ZmZn/w8PD/6Ghof+Ojo7/wsLC/6ysrP9DQ0P/UlJS////////////d3d3/y4uLv+RkZH/wcHB/52dnf+Xl5f/ycnJ/6Ojo/+dnZ3/xMTE/5iYmP+Tk5P/x8fH/5aWlv8mJib/zs7O////////////////////////////////////////////////////////////////////////////7+/v/zQ0NP95eXn/qamp/8rKyv+pqan/paWl/8vLy/++vr7/jIyM/6SkpP/Jycn/oqKi/5KSkv9cXFz/ISEh/+3t7f//////NTU1/0dHR/+cnJz/q6ur/8nJyf+kpKT/q6ur/8zMzP+4uLj/iIiI/6ioqP/IyMj/n5+f/4KCgv8vLy//0tLS/////////////////////////////////////////////////////////////////////////////////zs7O/9dXV3/srKy/9TU1P+Pj4//W1tb/7Ozs/+/v7//X19f/5CQkP/U1NT/ioqK/2BgYP9HR0f/Hx8f/zk5Of9DQ0P/HBwc/z09Pf+Hh4f/srKy/9PT0/+BgYH/YGBg/7y8vP+0tLT/WFhY/5ubm//Q0ND/gYGB/09PT/8tLS3/6urq////////////////////////////////////////////////////////////////////////////vb29/xgYGP9UVFT/09PT/9PT0/+rq6v/h4eH/7i4uP/FxcX/k5OT/6enp//Nzc3/sLCw/4SEhP8lJSX/NTU1/0lJSf9GRkb/PT09/xkZGf+NjY3/09PT/8/Pz/+ioqL/iIiI/729vf+/v7//kJCQ/66urv/MzMz/rq6u/1lZWf8XFxf/mJiY////////////////////////////////////////////////////////////////////////////ioqK/wQEBP8iIiL/np6e/7m5uf/Jycn/zc3N/6SkpP+Li4v/t7e3/87Ozv+pqan/o6Oj/1JSUv8kJCT/4eHh/////////////Pz8/0VFRf86Ojr/wsLC/7S0tP/MzMz/y8vL/52dnf+NjY3/vb29/8zMzP+oqKj/kJCQ/zExMf8GBgb/YmJi////////////////////////////////////////////////////////////////////////////4+Pj/6ioqP9FRUX/Gxsb/3Jycv/Q0ND/09PT/3p6ev9YWFj/nZ2d/9/f3/+hoaH/NjY2/xsbG//Q0ND///////////////////////f39/80NDT/NjY2/4iIiP/W1tb/ycnJ/29vb/9cXFz/qqqq/+Hh4f+IiIj/HR0d/zIyMv+enp7/19fX///////////////////////////////////////////////////////////////////////9/f3////////////7+/v/Tk5O/w4ODv9qamr/urq6/5WVlf95eXn/qamp/6Ojo/83Nzf/Jycn/8zMzP///////////////////////v7+///////s7Oz/ODg4/x0dHf+Li4v/wsLC/4+Pj/98fHz/qKio/4aGhv8dHR3/NDQ0/+Tk5P////////////39/f///////////////////////////////////////////////////////////////////////////////////////////5eXl/8wMDD/IiIi/zU1Nf84ODj/Li4u/yYmJv9vb2//8fHx//////////////////////////////////7+/v///////////4eHh/8sLCz/Kioq/zo6Ov82Njb/JiYm/yIiIv92dnb//Pz8///////////////////////////////////////////////////////////////////////////////////////////////////////+/v7////////////9/f3/zMzM/62trf+np6f/vLy8/+7u7v/////////////////////////////////////////////////+/v7////////////39/f/w8PD/6ioqP+qqqr/xcXF//Ly8v////////////7+/v////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////8AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=";

#[near_bindgen]
impl Contract {
    /// Initializes the contract with the given total supply owned by the given `owner_id` with
    /// default metadata (for example purposes only).
    #[init]
    pub fn new_default_meta(owner_id: AccountId, total_supply: U128) -> Self {
        Self::new(
            owner_id,
            total_supply,
            FungibleTokenMetadata {
                spec: FT_METADATA_SPEC.to_string(),
                name: "SIGHTED".to_string(),
                symbol: "SGT".to_string(),
                icon: Some(DATA_IMAGE_SVG_NEAR_ICON.to_string()),
                reference: None,
                reference_hash: None,
                decimals: 6,
            },
        )
    }

    /// Initializes the contract with the given total supply owned by the given `owner_id` with
    /// the given fungible token metadata.
    #[init]
    pub fn new(owner_id: AccountId, total_supply: U128, metadata: FungibleTokenMetadata) -> Self {
        assert!(!env::state_exists(), "Already initialized");
        metadata.assert_valid();
        let mut this = Self {
            token: FungibleToken::new(b"a".to_vec()),
            metadata: LazyOption::new(b"m".to_vec(), Some(&metadata)),
        };
        this.token.internal_register_account(&owner_id);
        this.token.internal_deposit(&owner_id, total_supply.into());
        near_contract_standards::fungible_token::events::FtMint {
            owner_id: &owner_id,
            amount: &total_supply,
            memo: Some("Initial tokens supply is minted"),
        }
        .emit();
        this
    }

    fn on_account_closed(&mut self, account_id: AccountId, balance: Balance) {
        log!("Closed @{} with {}", account_id, balance);
    }

    fn on_tokens_burned(&mut self, account_id: AccountId, amount: Balance) {
        log!("Account @{} burned {}", account_id, amount);
    }
}

near_contract_standards::impl_fungible_token_core!(Contract, token, on_tokens_burned);
near_contract_standards::impl_fungible_token_storage!(Contract, token, on_account_closed);

#[near_bindgen]
impl FungibleTokenMetadataProvider for Contract {
    fn ft_metadata(&self) -> FungibleTokenMetadata {
        self.metadata.get().unwrap()
    }
}

#[cfg(all(test, not(target_arch = "wasm32")))]
mod tests {
    use near_sdk::test_utils::{accounts, VMContextBuilder};
    use near_sdk::MockedBlockchain;
    use near_sdk::{testing_env, Balance};

    use super::*;

    const TOTAL_SUPPLY: Balance = 1_000_000_000_000_000;

    fn get_context(predecessor_account_id: AccountId) -> VMContextBuilder {
        let mut builder = VMContextBuilder::new();
        builder
            .current_account_id(accounts(0))
            .signer_account_id(predecessor_account_id.clone())
            .predecessor_account_id(predecessor_account_id);
        builder
    }

    #[test]
    fn test_new() {
        let mut context = get_context(accounts(1));
        testing_env!(context.build());
        let contract = Contract::new_default_meta(accounts(1).into(), TOTAL_SUPPLY.into());
        testing_env!(context.is_view(true).build());
        assert_eq!(contract.ft_total_supply().0, TOTAL_SUPPLY);
        assert_eq!(contract.ft_balance_of(accounts(1)).0, TOTAL_SUPPLY);
    }

    #[test]
    #[should_panic(expected = "The contract is not initialized")]
    fn test_default() {
        let context = get_context(accounts(1));
        testing_env!(context.build());
        let _contract = Contract::default();
    }

    #[test]
    fn test_transfer() {
        let mut context = get_context(accounts(2));
        testing_env!(context.build());
        let mut contract = Contract::new_default_meta(accounts(2).into(), TOTAL_SUPPLY.into());
        testing_env!(context
            .storage_usage(env::storage_usage())
            .attached_deposit(contract.storage_balance_bounds().min.into())
            .predecessor_account_id(accounts(1))
            .build());
        // Paying for account registration, aka storage deposit
        contract.storage_deposit(None, None);

        testing_env!(context
            .storage_usage(env::storage_usage())
            .attached_deposit(1)
            .predecessor_account_id(accounts(2))
            .build());
        let transfer_amount = TOTAL_SUPPLY / 3;
        contract.ft_transfer(accounts(1), transfer_amount.into(), None);

        testing_env!(context
            .storage_usage(env::storage_usage())
            .account_balance(env::account_balance())
            .is_view(true)
            .attached_deposit(0)
            .build());
        assert_eq!(
            contract.ft_balance_of(accounts(2)).0,
            (TOTAL_SUPPLY - transfer_amount)
        );
        assert_eq!(contract.ft_balance_of(accounts(1)).0, transfer_amount);
    }
}
